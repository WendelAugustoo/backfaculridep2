name: CI/CD - P2

on:
  push:
    branches:
      - main
    tags:
      - 'v*'        # tambÃ©m dispara em push de tags vX.Y.Z

permissions:
  contents: write

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1) CHECKOUT
      - name: â¬‡ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # necessÃ¡rio para Sonar e para o versionamento

      # 2) NODE / INSTALL
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      # 3) TESTES
      - name: ğŸ§ª Executar testes
        run: npm test
        # se no seu projeto for `npm run test`, troque aqui

      # 4) SAST / SONARCLOUD (NÃƒO QUEBRA O PIPELINE)
      - name: ğŸ” AnÃ¡lise estÃ¡tica com SonarCloud (SAST)
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
        continue-on-error: true   # <- mesmo se der nota ruim, o pipeline continua

      # 5) BUILD
      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
        run: npm run build

      # 6) VERSIONAMENTO (TAG SEMVER)
      - name: ğŸ§® Calcular nova versÃ£o e criar tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          release_branches: main
          default_bump: patch      # por padrÃ£o sobe sÃ³ o Ãºltimo nÃºmero (0.0.X)

      - name: ğŸ·ï¸ Atualizar package.json com nova versÃ£o
        if: steps.tag_version.outputs.new_version != ''
        run: |
          version=${{ steps.tag_version.outputs.new_version }}
          echo "Atualizando package.json para versÃ£o $version"

          npm version "$version" --no-git-tag-version

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json || true
          git commit -m "chore(release): versÃ£o $version" || echo "Nada para commitar"
          git push origin main

      # 7) DOCKER - LOGIN
      - name: ğŸ” Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 8) DOCKER - BUILD
      - name: ğŸ³ Build da imagem Docker
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/backfaculridep2"
          VERSION="${{ steps.tag_version.outputs.new_version }}"

          echo "Imagem base: $IMAGE"
          docker build -t "$IMAGE:latest" .

          if [ -n "$VERSION" ]; then
            echo "Marcando tambÃ©m com tag de versÃ£o: $VERSION"
            docker tag "$IMAGE:latest" "$IMAGE:$VERSION"
          fi

      # 9) DOCKER - PUSH
      - name: ğŸ“¤ Push da imagem para o Docker Hub
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/backfaculridep2"
          VERSION="${{ steps.tag_version.outputs.new_version }}"

          docker push "$IMAGE:latest"

          if [ -n "$VERSION" ]; then
            docker push "$IMAGE:$VERSION"
          fi

      # 10) DEPLOY NO RENDER
      - name: ğŸš€ Deploy no Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          wait-for-success: true
